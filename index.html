<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Sistema de Reservas | Corefo</title>
  <style>
    :root {
      --primary-color: #00468b; --hover-color: #003366; 
      --bg-color: #f7f9fa; --border-color: #e5e5e5;
      --text-main: #2b2b2b; --text-muted: #666666;
      --success-bg: #e6f4ea; --success-text: #137333;
      --disabled-bg: #f5f5f5; --danger-color: #d93025; 
      --info-bg: #e8f0fe;
    }
    
    body {
      font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background-color: var(--bg-color); display: flex; justify-content: center; align-items: center; 
      padding: 2vh 2vw; margin: 0; min-height: 100vh; box-sizing: border-box; color: var(--text-main);
      /* Optimización táctil */
      touch-action: pan-y;
    }
    
    .card {
      background: #ffffff; padding: 35px 40px; border-radius: 8px; 
      border: 1px solid var(--border-color); box-shadow: 0 10px 30px rgba(0,0,0,0.05);
      width: 100%; max-width: 850px; min-height: 80vh; 
      display: flex; flex-direction: column; box-sizing: border-box;
      border-top: 5px solid var(--primary-color);
    }
    
    .login-intranet {
      text-align: center; padding: 30px; background: #e8f0fe; 
      border: 2px dashed #00468b; border-radius: 8px; margin-bottom: 20px;
    }
    .login-intranet input { padding: 12px; width: 80%; max-width: 300px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; }
    .login-intranet button { padding: 12px 20px; margin-top: 15px; background: #00468b; color: white; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; touch-action: manipulation;}
    
    .app-content { display: none; flex-direction: column; flex-grow: 1;}

    .header { text-align: center; margin-bottom: 20px; }
    .header h2 { font-weight: 700; font-size: 1.8em; margin: 0; color: var(--text-main); }
    
    .campaign-info { background-color: var(--info-bg); border-left: 4px solid var(--primary-color); padding: 15px 20px; border-radius: 0 6px 6px 0; margin-bottom: 25px; font-size: 0.95em; line-height: 1.6; text-align: justify; }
    
    .user-info { font-size: 0.95em; color: var(--text-muted); margin-bottom: 25px; text-align: center; padding: 15px; background: #fafafa; border: 1px solid var(--border-color); border-radius: 6px; }
    
    .already-booked-panel { display: none; text-align: center; padding: 30px 20px; background-color: #f8fbff; border: 1px solid #cce0ff; border-radius: 6px; margin-bottom: 20px; }
    .shift-assigned { font-size: 1.8em; font-weight: 700; color: var(--primary-color); margin: 15px 0; }

    .schedule-container { display: none; border: 1px solid var(--border-color); border-radius: 6px; margin-bottom: 20px; flex-grow: 1; overflow-y: auto; background-color: #fff; max-height: 400px; }
    
    .shift-row { display: flex; align-items: center; justify-content: space-between; padding: 16px 20px; border-bottom: 1px solid var(--border-color); }
    .shift-row:hover { background-color: #fdfdfd; }
    
    .shift-time { font-size: 1.1em; font-weight: 600; width: 90px; }
    
    .btn-reserve { padding: 10px 22px; background-color: var(--primary-color); color: white; border: none; border-radius: 4px; font-weight: 600; cursor: pointer; touch-action: manipulation; }
    .btn-cancel { padding: 10px 22px; background-color: transparent; color: var(--text-muted); border: 1px solid var(--text-muted); border-radius: 4px; font-weight: 600; cursor: pointer; margin-top: 15px; }
    
    .message { margin-top: 10px; text-align: center; font-weight: 600; padding: 15px; border-radius: 4px; display: none; }
    .success { background-color: var(--success-bg); color: var(--success-text); border: 1px solid #c3e6cb; }
    .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    
    #loader { text-align: center; font-weight: 600; color: var(--primary-color); padding: 20px; display:none;}

    @media (max-width: 600px) {
      .card { padding: 20px 15px; min-height: 100vh; border-radius: 0; }
      .shift-time { font-size: 1em; width: 70px; }
      .btn-reserve { padding: 8px 15px; font-size: 0.9em; }
    }
  </style>
</head>
<body>

  <div class="card">
    <div id="pantallaLogin" class="login-intranet">
      <h2>Acceso Intranet Corefo</h2>
      <p>Ingresa tu correo corporativo:</p>
      <input type="email" id="correoIngresado" placeholder="ejemplo@corefo.com">
      <br>
      <button onclick="simularAutenticacion()">Ingresar</button>
    </div>

    <div id="pantallaApp" class="app-content">
      <div class="header"><h2>Reserva de Turno</h2></div>
      <div class="campaign-info">Campaña de Salud Preventiva - Martes 24 de Febrero. Vacunación Hepatitis B y Neumococo.</div>
      
      <div id="loader">Cargando agenda...</div>
      <div class="user-info" id="userInfoCard" style="display:none;">
        <strong id="userName"></strong><br><small id="userEmail"></small>
      </div>

      <div id="alreadyBookedPanel" class="already-booked-panel">
        <h3>Tu turno actual:</h3>
        <div class="shift-assigned" id="assignedTime"></div>
        <button id="btnCancelShift" class="btn-cancel" onclick="cancelarReserva()">Cancelar y cambiar</button>
      </div>

      <div id="scheduleContainer" class="schedule-container"></div>
      <div id="message" class="message"></div>
    </div>
  </div>

  <script>
    // PEGA AQUÍ TU URL DE GOOGLE APPS SCRIPT
    const URL_API_GOOGLE = "https://script.google.com/macros/s/AKfycbxvAUFhCZ_z9axN9LK6mQpKUR8mlJz08itC6CQdMg6G7DCtF_zuUTJ4S5xYzdbVxi4rmg/exec"; 
    
    let correoColaborador = "";

    function simularAutenticacion() {
      const emailInput = document.getElementById('correoIngresado').value.trim();
      if (!emailInput) { alert("Ingresa un correo válido"); return; }
      correoColaborador = emailInput;
      document.getElementById('pantallaLogin').style.display = 'none';
      document.getElementById('pantallaApp').style.display = 'flex';
      cargarDatos();
    }

    function cargarDatos() {
      document.getElementById('loader').style.display = 'block';
      document.getElementById('scheduleContainer').style.display = 'none';
      document.getElementById('alreadyBookedPanel').style.display = 'none';
      
      fetch(`${URL_API_GOOGLE}?accion=obtenerAgenda&correo=${encodeURIComponent(correoColaborador)}`)
        .then(res => res.json())
        .then(datos => {
          document.getElementById('loader').style.display = 'none';
          if(datos.error) { mostrarMensaje(datos.error, 'error'); return; }
          renderizar(datos);
        })
        .catch(() => mostrarMensaje('Error de conexión', 'error'));
    }

    function renderizar(response) {
      document.getElementById('userName').textContent = response.colab.nombres + ' ' + response.colab.apellidos;
      document.getElementById('userEmail').textContent = response.colab.correo;
      document.getElementById('userInfoCard').style.display = 'block';

      if (response.turnoAsignado) {
        document.getElementById('assignedTime').textContent = response.turnoAsignado;
        document.getElementById('alreadyBookedPanel').style.display = 'block';
      } else {
        const container = document.getElementById('scheduleContainer');
        container.innerHTML = '';
        response.turnos.forEach(t => {
          const row = document.createElement('div');
          row.className = 'shift-row';
          row.innerHTML = `
            <div class="shift-time">${t.hora}</div>
            <div>${t.estado === 'Disponible' ? 
              `<button class="btn-reserve" onclick="guardarReserva('${t.hora}', this)">Reservar</button>` : 
              '<span style="color:red">Ocupado</span>'}</div>
          `;
          container.appendChild(row);
        });
        container.style.display = 'block';
      }
    }

    function guardarReserva(hora, btn) {
      btn.disabled = true; btn.textContent = '...';
      fetch(`${URL_API_GOOGLE}?accion=reservarTurno&correo=${encodeURIComponent(correoColaborador)}&turno=${encodeURIComponent(hora)}`)
        .then(res => res.json())
        .then(res => { if(res.success) cargarDatos(); else mostrarMensaje(res.message, 'error'); });
    }

    function cancelarReserva() {
      fetch(`${URL_API_GOOGLE}?accion=cancelarTurno&correo=${encodeURIComponent(correoColaborador)}`)
        .then(res => res.json())
        .then(res => { if(res.success) cargarDatos(); });
    }

    function mostrarMensaje(t, tipo) {
      const m = document.getElementById('message');
      m.textContent = t; m.className = 'message ' + tipo; m.style.display = 'block';
    }
  </script>
</body>
</html>
